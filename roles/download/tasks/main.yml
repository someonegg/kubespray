---
- name: download | Prepare working directories and variables
  import_tasks: prep_download.yml
  when:
    - not skip_downloads|default(false)
  tags:
    - download
    - upload

- name: Use cri-o for cri connection
  set_fact:
    cri_socket: /var/run/crio/crio.sock
  when: container_manager == 'crio'

- name: Use containerd for cri connetion
  set_fact:
    cri_socket: /var/run/containerd/containerd.sock
  when: container_manager == 'containerd'

- name: Use docker for cri connetion
  set_fact:
    cri_socket: /var/run/dockershim.sock
  when: container_manager == 'docker'

- include_tasks: ../../container-engine/containerd/tasks/crictl.yml
  when:
    - not skip_downloads|default(false)
    - container_manager in ['containerd', 'crio']

- name: download | Get kubeadm binary and list of required images
  include_tasks: prep_kubeadm_images.yml
  when:
    - not skip_downloads|default(false)
    - inventory_hostname in groups['kube-master']
  tags:
    - download
    - upload

- name: download | Download files
  include_tasks: "{{ include_file }}"
  with_dict: "{{ downloads | combine(kubeadm_images) }}"
  vars:
    download_localhost: "{{ download_file_localhost }}"
    download: "{{ download_defaults | combine(item.value) }}"
    include_file: "download_file.yml"
  when:
    - not skip_downloads | default(false)
    - download.enabled
    - item.value.enabled
    - item.value.file | default(false)
    - (download_run_once and inventory_hostname == download_delegate) or (group_names | intersect(download.groups) | length)

- name: download | Download images
  include_tasks: "{{ include_file }}"
  with_dict: "{{ downloads | combine(kubeadm_images) }}"
  vars:
    download: "{{ download_defaults | combine(item.value) }}"
    include_file: "download_container.yml"
  when:
    - not skip_downloads | default(false)
    - download.enabled
    - item.value.enabled
    - (item.value.container | default(false)) and (item.value.container and download_container)
    - (download_run_once and inventory_hostname == download_delegate) or (group_names | intersect(download.groups) | length)

- name: download | Sync files from ansible host to nodes
  include_tasks: "{{ include_file }}"
  with_dict: "{{ downloads | combine(kubeadm_images) }}"
  vars:
    download_localhost: "{{ download_file_localhost }}"
    download: "{{ download_defaults | combine(item.value) }}"
    include_file: "sync_file.yml"
  when:
    - not skip_downloads | default(false)
    - download.enabled
    - item.value.enabled
    - item.value.file | default(false)
    - download_run_once
    - group_names | intersect(download.groups) | length
    - not (inventory_hostname == download_delegate)

- name: download | Sync images from ansible host to nodes
  include_tasks: "{{ include_file }}"
  with_dict: "{{ downloads | combine(kubeadm_images) }}"
  vars:
    download: "{{ download_defaults | combine(item.value) }}"
    include_file: "sync_container.yml"
  when:
    - not skip_downloads | default(false)
    - download.enabled
    - item.value.enabled
    - item.value.container | default(false)
    - download_run_once
    - group_names | intersect(download.groups) | length
    - not (inventory_hostname == download_delegate)
